name: .NET Cross-Platform Build

on:
  workflow_dispatch:
    inputs:
      build_mode:
        description: 'Build configuration'
        required: true
        default: 'debug'
        type: choice
        options: 
          - debug
          - release

jobs:
  build:
    name: Build [${{ inputs.build_mode }}]
    strategy:
      matrix:
        platform: [linux-x64, win-x64, mac-arm64]
        include:
          - platform: linux-x64
            os: ubuntu-latest
            shell: bash
          - platform: win-x64
            os: windows-latest
            shell: pwsh
          - platform: mac-arm64
            os: macos-13
            shell: bash

    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: ${{ matrix.shell }}

    steps:
      - name: ğŸ” Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive  # å…³é”®ä¿®å¤ç‚¹ï¼šç¡®ä¿å­æ¨¡å—æ£€å‡º

      - name: ğŸ§¹ Clean Workspace
        run: |
          # åˆ é™¤å¯èƒ½å­˜åœ¨çš„æ®‹ç•™æ–‡ä»¶
          rm -rf ./bin ./obj 2>/dev/null || true

      - name: ğŸ“‚ Debug Directory Structure
        run: |
          echo "å·¥ä½œåŒºè·¯å¾„: $GITHUB_WORKSPACE"
          ls -lR  # æ˜¾ç¤ºå®Œæ•´ç›®å½•ç»“æ„

      - name: ğŸ” Locate Project File
        id: find_project
        run: |
          # ç²¾ç¡®æŸ¥æ‰¾æ’é™¤æµ‹è¯•é¡¹ç›®
          PROJECT_FILE=$(find . -name '*.csproj' \
            -not -path '*/test/*' \
            -not -path '*/tests/*' \
            -not -path '*/example/*' \
            -print -quit)
          
          if [ -z "$PROJECT_FILE" ]; then
            echo "::error::æœªæ‰¾åˆ°ä»»ä½•.csprojé¡¹ç›®æ–‡ä»¶!"
            exit 1
          fi

          echo "å‘ç°é¡¹ç›®æ–‡ä»¶: $PROJECT_FILE"
          echo "PROJ_PATH=${PROJECT_FILE}" >> $GITHUB_ENV

      - name: âš™ï¸ Setup .NET 9.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            9.0.x

      - name: ğŸ—ï¸ Build Project
        run: |
          dotnet build "${{ env.PROJ_PATH }}" \
            --configuration ${{ inputs.build_mode }} \
            --runtime ${{ matrix.platform }} \
            --no-restore \
            --output ./artifacts/${{ matrix.platform }}
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: 1  # ç¦ç”¨é¥æµ‹
          DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1

      - name: ğŸšš Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-build
          path: ./artifacts/${{ matrix.platform }}
          if-no-files-found: error
