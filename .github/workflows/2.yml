name: .NET Cross-Platform Build

on:
  workflow_dispatch:
    inputs:
      build_mode:
        description: 'Build configuration'
        required: true
        default: 'debug'
        type: choice
        options: 
          - debug
          - release

jobs:
  build:
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          path: 'src'  # 显式指定检出路径

      - name: 🔍 智能项目查找
        id: find_proj
        run: |
          # 使用绝对路径 + 深度搜索
          WORKSPACE="$GITHUB_WORKSPACE/src"  # 匹配检出路径
          
          # 扩展搜索模式
          PROJECT_FILE=$(find "$WORKSPACE" \
            -iregex '.*\.csproj$' \
            -not -ipath '*/test/*' \
            -not -ipath '*/examples/*' \
            -print -quit)
          
          # 多级验证
          if [[ ! -f "$PROJECT_FILE" ]]; then
            echo "::error::Critical: No valid .csproj found in:"
            find "$WORKSPACE" -name '*.*proj*' -exec echo '  --> {}' \;  # 调试输出
            exit 1
          fi
          
          echo "PROJ_PATH=${PROJECT_FILE#$WORKSPACE/}" >> $GITHUB_ENV
          echo "Found project at: ${{ env.PROJ_PATH }}"

      - name: 🛠️ 动态构建
        run: dotnet build "${{ env.PROJ_PATH }}" --output ./bin
        env:
          DOTNET_CLI_UI_LANGUAGE: en  # 强制英文输出
