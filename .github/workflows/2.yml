# æ–‡ä»¶å: .github/workflows/build.yml
name: ğŸš€ å…¨å¹³å°æ„å»ºå·¥ä½œæµ

# æ‰‹åŠ¨è§¦å‘ + å®šæ—¶è§¦å‘ + ä»£ç æ¨é€è§¦å‘
on:
  workflow_dispatch:    # æ‰‹åŠ¨è§¦å‘
    inputs:
      build_mode:
        description: 'æ„å»ºæ¨¡å¼ (å¿…é€‰)'
        required: true
        type: choice
        options:
          - debug
          - release
      target_os:
        description: 'ç›®æ ‡ç³»ç»Ÿ (å¯ç©º)'
        required: false
        type: string
        default: 'all'
  schedule:
    - cron: '0 2 * * 1'  # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹è‡ªåŠ¨æ„å»º
  push:
    branches:
      - main

jobs:
  multi-platform-build:
    name: ğŸ› ï¸ æ„å»º ${{ matrix.platform }}
    runs-on: ${{ 
      contains(matrix.platform, 'win') && 'windows-latest' || 
      contains(matrix.platform, 'mac') && 'macos-latest' || 
      'ubuntu-latest' 
    }}
    
    strategy:
      matrix:
        platform: 
          - linux-x64
          - win-x64
          - mac-arm64
        include:
          - platform: linux-x64
            os-type: linux
          - platform: win-x64
            os-type: windows
          - platform: mac-arm64
            os-type: macos

    steps:
    # â–ˆâ–ˆâ–ˆ åˆå§‹åŒ–é˜¶æ®µ â–ˆâ–ˆâ–ˆ
    - name: â¬‡ï¸ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²
        submodules: recursive

    # â–ˆâ–ˆâ–ˆ å®‰å…¨é…ç½® â–ˆâ–ˆâ–ˆ
    - name: ğŸ”‘ SSH å¯†é’¥é…ç½®
      if: matrix.os-type == 'linux'  # ä»…é™Linux
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    # â–ˆâ–ˆâ–ˆ æ„å»ºé˜¶æ®µ â–ˆâ–ˆâ–ˆ
    - name: ğŸ› ï¸ åˆå§‹åŒ–æ„å»ºç¯å¢ƒ
      shell: bash
      run: |
        # åŠ¨æ€æ„å»ºå‚æ•°å¤„ç†
        BUILD_FLAGS="-DCMAKE_BUILD_TYPE=${{ inputs.build_mode }}"
        
        case ${{ matrix.platform }} in
          linux-x64)
            sudo apt-get update && sudo apt-get install -y clang-16 llvm-16
            ;;
          win-x64)
            choco install llvm --version=16.0.6 -y
            ;;
          mac-arm64)
            brew install llvm@16
            ;;
        esac

    - name: ğŸš§ æ‰§è¡Œç¼–è¯‘
      env:
        BUILD_OUTPUT: "build-${{ matrix.platform }}"
      run: |
        cmake -B $BUILD_OUTPUT -S . $BUILD_FLAGS
        cmake --build $BUILD_OUTPUT --parallel 4

    # â–ˆâ–ˆâ–ˆ åå¤„ç†é˜¶æ®µ â–ˆâ–ˆâ–ˆ
    - name: ğŸ“¦ äº§ç‰©æ‰“åŒ…
      if: ${{ inputs.build_mode == 'release' }}
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.platform }}-binaries
        path: |
          build-${{ matrix.platform }}/**/*.exe
          build-${{ matrix.platform }}/**/*.so
          build-${{ matrix.platform }}/**/*.d
