name: .NET Multi-platform Build

on:
  workflow_dispatch:
    inputs:
      build_mode:
        description: 'Build mode'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          release

jobs:
  build:
    strategy:
      matrix:
        platform: [linux-x64, win-x64, mac-arm64]
        include:  # ä¿®å¤è·¨å¹³å°å‚æ•°å·®å¼‚
          - platform: win-x64
            build_args: '/p:DefineConstants="WINDOWS"'
          - platform: linux-x64
            build_args: '-p:DefineConstants="LINUX"'
          - platform: mac-arm64
            build_args: '-p:DefineConstants="MAC"'

    runs-on: ${{ 
      matrix.platform == 'win-x64' && 'windows-latest' ||
      matrix.platform == 'mac-arm64' && 'macos-13' || 
      'ubuntu-latest' 
    }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ§¹ æ¸…ç†æ®‹ç•™æ–‡ä»¶
        run: rm -rf ./artifacts  # é˜²æ­¢æ—§æ„å»ºäº§ç‰©å¹²æ‰°

      - name: ğŸ” æ·±åº¦è·¯å¾„æ‰«æ
        id: find_proj
        run: |
          # ä½¿ç”¨æ›´ç²¾ç¡®çš„æŸ¥æ‰¾å‘½ä»¤
          PROJ_FILE=$(find "$GITHUB_WORKSPACE" -name '*.csproj' -not -path '*/bin/*' -not -path '*/obj/*' -print -quit)
          echo "PROJ_PATH=${PROJ_FILE#$GITHUB_WORKSPACE/}" >> $GITHUB_ENV
          echo "Found project: ${{ env.PROJ_PATH }}"

      - name: âš™ï¸ å®‰è£… .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: | 
            8.0.x

      - name: ğŸ—ï¸ è·¨å¹³å°ç¼–è¯‘
        run: |
          dotnet build "${{ env.PROJ_PATH }}" \
            ${{ matrix.build_args }} \
            --configuration ${{ inputs.build_mode }} \
            --runtime ${{ matrix.platform }} \
            --output ./artifacts/${{ matrix.platform }}
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: 1  # ç¦ç”¨é¥æµ‹

      - name: ğŸ“¦ æ™ºèƒ½æ‰“åŒ…
        if: ${{ inputs.build_mode == 'release' }}
        run: |
          mkdir -p packaged
          7z a -t7z packaged/${{ matrix.platform }}.7z ./artifacts/${{ matrix.platform }}/*

      - name: ğŸš¢ ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-${{ github.run_id }}
          path: ./packaged/${{ matrix.platform }}.7z
